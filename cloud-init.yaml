#cloud-config
package_update: true
package_upgrade: true

packages:
  - wireguard
  - qrencode
  - ufw
  - iptables
  - iptables-persistent
  - netfilter-persistent

runcmd:
  # Enable IP forwarding
  - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
  - echo "net.ipv6.conf.all.forwarding=1" >> /etc/sysctl.conf
  - sysctl -p

  # Create WireGuard directory
  - mkdir -p /etc/wireguard
  - chmod 700 /etc/wireguard

  # Generate WireGuard keys
  - wg genkey | tee /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key
  - chmod 600 /etc/wireguard/server_private.key
  - chmod 644 /etc/wireguard/server_public.key

  # Create WireGuard configuration file template
  - |
    cat > /etc/wireguard/wg0.conf.template << 'EOF'
    [Interface]
    Address = 10.8.0.1/24
    ListenPort = 51820
    PrivateKey = SERVER_PRIVATE_KEY
    PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
    PostUp = iptables -A FORWARD -o wg0 -j ACCEPT
    PostUp = iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE
    PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
    PostDown = iptables -D FORWARD -o wg0 -j ACCEPT
    PostDown = iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE

    # Add client configurations below
    # [Peer]
    # PublicKey = CLIENT_PUBLIC_KEY
    # AllowedIPs = 10.8.0.2/32
    EOF

  # Replace the private key in the config
  - sed "s|SERVER_PRIVATE_KEY|$(cat /etc/wireguard/server_private.key)|" /etc/wireguard/wg0.conf.template > /etc/wireguard/wg0.conf
  - chmod 600 /etc/wireguard/wg0.conf

  # Fix OCI iptables REJECT rule issue
  # OCI adds a REJECT rule that blocks traffic before UFW rules
  # We need to insert WireGuard rule BEFORE the REJECT rule
  - |
    # Wait for iptables to be ready
    sleep 2

    # Find the line number of the REJECT rule in INPUT chain
    REJECT_LINE=$(iptables -L INPUT --line-numbers | grep -m 1 "REJECT.*icmp-host-prohibited" | awk '{print $1}')

    # If REJECT rule exists, insert WireGuard rule before it
    if [ -n "$REJECT_LINE" ]; then
      iptables -I INPUT $REJECT_LINE -p udp --dport 51820 -j ACCEPT -m comment --comment "WireGuard VPN"
      iptables -I INPUT $REJECT_LINE -p tcp --dport 1194 -j ACCEPT -m comment --comment "OpenVPN TCP"
      iptables -I INPUT $REJECT_LINE -p udp --dport 1194 -j ACCEPT -m comment --comment "OpenVPN UDP"
      echo "Inserted WireGuard/OpenVPN rules before REJECT rule at line $REJECT_LINE"
    else
      # If no REJECT rule, just append the rules
      iptables -A INPUT -p udp --dport 51820 -j ACCEPT -m comment --comment "WireGuard VPN"
      iptables -A INPUT -p tcp --dport 1194 -j ACCEPT -m comment --comment "OpenVPN TCP"
      iptables -A INPUT -p udp --dport 1194 -j ACCEPT -m comment --comment "OpenVPN UDP"
      echo "No REJECT rule found, appended WireGuard/OpenVPN rules"
    fi

    # Save iptables rules to persist across reboots
    netfilter-persistent save

    # Also save using iptables-save as backup
    iptables-save > /etc/iptables/rules.v4

  # Configure firewall
  - ufw --force enable
  - ufw allow 22/tcp
  - ufw allow 51820/udp
  - ufw allow 1194/tcp
  - ufw allow 1194/udp

  # Enable and start WireGuard
  - systemctl enable wg-quick@wg0
  - systemctl start wg-quick@wg0

  # Create helper script for adding clients
  - |
    cat > /usr/local/bin/add-wireguard-client << 'SCRIPT'
    #!/bin/bash
    if [ -z "$1" ]; then
      echo "Usage: add-wireguard-client <client-name>"
      exit 1
    fi

    CLIENT_NAME=$1
    SERVER_PUBLIC_IP=$(curl -s ifconfig.me)
    SERVER_PUBLIC_KEY=$(cat /etc/wireguard/server_public.key)
    CLIENT_PRIVATE_KEY=$(wg genkey)
    CLIENT_PUBLIC_KEY=$(echo $CLIENT_PRIVATE_KEY | wg pubkey)
    CLIENT_IP="10.8.0.$(($(wg show wg0 peers | wc -l) + 2))"

    # Add peer to server config
    cat >> /etc/wireguard/wg0.conf << EOF

    [Peer]
    # $CLIENT_NAME
    PublicKey = $CLIENT_PUBLIC_KEY
    AllowedIPs = $CLIENT_IP/32
    EOF

    # Restart WireGuard
    systemctl restart wg-quick@wg0

    # Generate client config
    cat > /root/wireguard-$CLIENT_NAME.conf << EOF
    [Interface]
    PrivateKey = $CLIENT_PRIVATE_KEY
    Address = $CLIENT_IP/24
    DNS = 1.1.1.1, 8.8.8.8

    [Peer]
    PublicKey = $SERVER_PUBLIC_KEY
    Endpoint = $SERVER_PUBLIC_IP:51820
    AllowedIPs = 0.0.0.0/0, ::/0
    PersistentKeepalive = 25
    EOF

    echo "Client configuration created: /root/wireguard-$CLIENT_NAME.conf"
    echo "Server public key: $SERVER_PUBLIC_KEY"
    echo "Client added successfully!"

    # Generate QR code
    qrencode -t ansiutf8 < /root/wireguard-$CLIENT_NAME.conf
    SCRIPT

  - chmod +x /usr/local/bin/add-wireguard-client

  # Create setup completion marker
  - touch /var/log/wireguard-setup-complete
